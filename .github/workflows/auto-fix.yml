# ═══════════════════════════════════════════════════════════════════════════
# Auto-Fix Workflow - Automated Code Quality Advisory
# ═══════════════════════════════════════════════════════════════════════════
#
# Purpose: Provide automated advisory comments on pull requests
#
# Triggers:
#   - Pull request opened, updated, or reopened
#   - Manual trigger via GitHub UI (workflow_dispatch)
#
# Non-Blocking:
#   - Always continues on error (advisory only)
#   - Will not fail your PR
#   - Provides guidance, not enforcement
#
# Path Filtering:
#   - Only runs if code-related files change
#   - Monitored paths: src/, sanity/, seed/, public/, config files
#
# Fork Safety:
#   - Fork PRs: Advisory only (no code execution)
#   - Same-repo PRs: Runs auto-fix script
#   - Security-conscious handling of untrusted code
#
# Advisory Checks:
#   - Agent field in PR body (Lovable/Codex/Gemini/Human)
#   - CHANGELOG.md update reminder
#   - GROQ import style (plain string vs import)
#   - Code quality suggestions
#
# Comment Behavior:
#   - Posts "sticky" comment (updates existing, doesn't spam)
#   - Uses hidden marker for comment identification
#   - Automatically updates on PR changes
#
# Permissions:
#   - contents: read (checkout code)
#   - pull-requests: write (post comments)
#
# Timeout: 5 minutes (prevents stuck jobs)
#
# ═══════════════════════════════════════════════════════════════════════════

name: Auto-Fix (non-blocking)

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  workflow_dispatch:

jobs:
  autofix:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    continue-on-error: true
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Notice (advisory only; won't fail)
        run: echo "::notice title=Auto-Fix::This job is advisory and will not fail your PR."

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'src/**'
              - 'sanity/**'
              - 'seed/**'
              - 'public/**'
              - 'package*.json'
              - 'tsconfig*.json'
              - 'tailwind.config.ts'
              - 'vite.config.ts'
              - '.github/**'

      - name: Setup Node
        if: steps.filter.outputs.code == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 20
          check-latest: true
          cache: npm

      # Compose advisory WITHOUT executing repo code when PR is from a fork
      - name: Compose advisory (fork-safe)
        id: compose
        if: steps.filter.outputs.code == 'true' && github.event.pull_request.head.repo.fork == true
        run: |
          {
            echo "advisory<<EOF"
            echo "### Auto-Fix advisory <!-- auto-fix-advisory -->"
            echo ""
            echo "- Fork PR detected. Auto-commit is disabled for security."
            echo "- Please add an \`Agent:\` line in PR body (Lovable | Codex | Gemini | Human) if missing."
            echo "- If code changed, ensure \`CHANGELOG.md\` is updated (CI will advise)."
            echo "- Use plain-string GROQ (no \`import 'groq'\`)."
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # Same-repo PRs: run our script (safe to execute) which sets the advisory via $GITHUB_OUTPUT
      - name: Install (same-repo only)
        if: steps.filter.outputs.code == 'true' && github.event.pull_request.head.repo.fork == false
        run: npm ci --ignore-scripts

      - name: Run auto-fix script (same-repo only)
        id: run
        if: steps.filter.outputs.code == 'true' && github.event.pull_request.head.repo.fork == false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node scripts/auto-fix.mjs

      # Always post (if we have some advisory), using a sticky comment + hidden marker
      - name: Post advisory comment
        if: always() && (steps.run.outputs.advisory || steps.compose.outputs.advisory)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: auto-fix-advisory
          message: ${{ steps.run.outputs.advisory || steps.compose.outputs.advisory }}

      - name: Summary
        if: always()
        run: |
          echo "## Auto-Fix Result" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.run.outputs.advisory }}" ]; then
            echo "${{ steps.run.outputs.advisory }}" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ steps.compose.outputs.advisory }}" ]; then
            echo "${{ steps.compose.outputs.advisory }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "No advisory messages (nothing relevant changed)." >> $GITHUB_STEP_SUMMARY
          fi
