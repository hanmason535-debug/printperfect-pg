# ═══════════════════════════════════════════════════════════════════════════
# Performance Monitoring Workflow - Lighthouse CI & Bundle Analysis
# ═══════════════════════════════════════════════════════════════════════════
#
# Purpose: Monitor web performance metrics and bundle size
#
# Triggers:
#   - Pull requests that change source code, assets, or build config
#   - Manual trigger via GitHub UI (workflow_dispatch)
#
# Path Filters (only runs if these change):
#   - src/** (components, hooks, styles)
#   - public/** (static assets)
#   - package*.json (dependencies)
#   - vite.config.ts (build configuration)
#
# Jobs:
#   1. Lighthouse CI - Web performance audits
#   2. Bundle Analysis - Asset size and composition tracking
#
# Lighthouse Metrics:
#   - Performance score
#   - Accessibility score
#   - Best Practices score
#   - SEO score
#   - First Contentful Paint (FCP)
#   - Largest Contentful Paint (LCP)
#   - Time to Interactive (TTI)
#   - Cumulative Layout Shift (CLS)
#
# Bundle Analysis:
#   - Top 20 largest files by size
#   - Asset count breakdown (JS, CSS, images)
#   - Total bundle size
#   - Posted to GitHub Step Summary
#
# Permissions:
#   - contents: read (checkout code)
#   - pull-requests: write (post comments)
#
# Conditions:
#   - Skips draft pull requests
#   - Only runs on non-draft PRs with relevant changes
#
# Lighthouse Storage:
#   - Reports uploaded to temporary public storage
#   - Accessible via GitHub Actions summary
#
# ═══════════════════════════════════════════════════════════════════════════

name: Performance Monitoring

on:
  pull_request:
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'vite.config.ts'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject Sanity env vars
        run: |
          echo "VITE_SANITY_PROJECT_ID=${{ secrets.VITE_SANITY_PROJECT_ID }}" >> $GITHUB_ENV
          echo "VITE_SANITY_DATASET=${{ secrets.VITE_SANITY_DATASET }}" >> $GITHUB_ENV

      - name: Build for performance test
        run: npm run build

      - name: Serve built files
        run: npx serve -s dist -l 8080 &
        
      - name: Wait for server
        run: npx wait-on http://localhost:8080 --timeout 30000

      - name: Run Lighthouse
        run: |
          npm install -g @lhci/cli
          lhci autorun --upload.target=temporary-public-storage || echo "Lighthouse completed with warnings"
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Inject Sanity env vars
        run: |
          echo "VITE_SANITY_PROJECT_ID=${{ secrets.VITE_SANITY_PROJECT_ID }}" >> $GITHUB_ENV
          echo "VITE_SANITY_DATASET=${{ secrets.VITE_SANITY_DATASET }}" >> $GITHUB_ENV

      - name: Analyze bundle
        run: |
          npm run build
          
          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### Files by size:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find dist -type f -exec du -h {} + | sort -rh | head -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Count assets
          JS_COUNT=$(find dist -name "*.js" | wc -l)
          CSS_COUNT=$(find dist -name "*.css" | wc -l)
          IMG_COUNT=$(find dist -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.svg" -o -name "*.webp" \) | wc -l)
          
          echo "### Asset counts:" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript files: $JS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- CSS files: $CSS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- Image files: $IMG_COUNT" >> $GITHUB_STEP_SUMMARY
